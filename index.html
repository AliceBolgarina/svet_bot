<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç -->
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            z-index: 1000;
            text-align: center;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 14px;
            color: #666;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ */
        .search-toggle {
            position: fixed;
            top: 90px;
            left: 16px;
            right: 16px;
            z-index: 1001;
        }
        
        .search-toggle-btn {
            width: 100%;
            padding: 14px 20px;
            background: white;
            border: 1px solid #667eea;
            border-radius: 12px;
            color: #667eea;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
        .search-panel {
            position: fixed;
            top: 90px;
            left: 16px;
            right: 16px;
            z-index: 1002;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .cancel-btn {
            width: 100%;
            padding: 10px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã */
        .map-container {
            position: fixed;
            top: 140px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –∫–Ω–æ–ø–∫–æ–π */
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }
        
        #delivery-widget {
            width: 100%;
            height: 100%;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ø–Ω–¥–µ–∫—Å–∞ */
        #delivery-widget .sidebar,
        #delivery-widget .search-panel {
            display: none !important;
        }
        
        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ –Ø–Ω–¥–µ–∫—Å */
        .yandex-delivery-widget .search-bar {
            display: none !important;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            text-align: center;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */
        .instruction {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #667eea;
            text-align: center;
            font-size: 14px;
            color: #333;
            z-index: 999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å –≤–∞—Ä–∏–∞–Ω—Ç</p>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞ -->
    <div class="search-toggle" id="searchToggle">
        <button class="search-toggle-btn" id="searchToggleBtn">
            üîç –ù–∞–π—Ç–∏ –≥–æ—Ä–æ–¥
        </button>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
    <div class="search-panel" id="searchPanel">
        <div class="search-input-group">
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è"
                   value="–ú–æ—Å–∫–≤–∞">
            <button class="search-btn" id="searchBtn">–ü–æ–∏—Å–∫</button>
        </div>
        <button class="cancel-btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
    
    <!-- –ö–∞—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å -->
    <div class="map-container">
        <div id="delivery-widget"></div>
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>
    
    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="instruction" id="instruction">
        üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç"
    </div>
    
    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let yandexWidget = null;
        let isTelegram = false;
        let selectedPVZ = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞—Ç–∞');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                isTelegram = true;
                initTelegramWebApp();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
            initSearch();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞
            initYandexWidget();
        });
        
        function initTelegramWebApp() {
            try {
                const tg = Telegram.WebApp;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                tg.expand(); // –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                tg.setHeaderColor('#ffffff');
                tg.setBackgroundColor('#ffffff');
                
                // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    tg.close();
                });
                
                tg.ready();
                console.log('‚úÖ Telegram Web App –≥–æ—Ç–æ–≤');
                
            } catch (error) {
                console.error('‚ùå Telegram Web App –æ—à–∏–±–∫–∞:', error);
            }
        }
        
        function initSearch() {
            const toggleBtn = document.getElementById('searchToggleBtn');
            const searchPanel = document.getElementById('searchPanel');
            const searchBtn = document.getElementById('searchBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const searchInput = document.getElementById('searchInput');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–∏—Å–∫
            toggleBtn.addEventListener('click', function() {
                searchPanel.style.display = 'block';
                toggleBtn.style.display = 'none';
                searchInput.focus();
            });
            
            // –ü–æ–∏—Å–∫
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query) {
                    updateWidgetCity(query);
                    searchPanel.style.display = 'none';
                    toggleBtn.style.display = 'block';
                }
            });
            
            // –û—Ç–º–µ–Ω–∞
            cancelBtn.addEventListener('click', function() {
                searchPanel.style.display = 'none';
                toggleBtn.style.display = 'block';
            });
            
            // Enter –¥–ª—è –ø–æ–∏—Å–∫–∞
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }
        
        function initYandexWidget() {
            console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            if (window.YaDelivery) {
                createWidget();
            } else {
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
                document.addEventListener('YaNddWidgetLoad', createWidget);
                
                // –¢–∞–π–º–∞—É—Ç
                setTimeout(function() {
                    if (!yandexWidget) {
                        console.error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞');
                        document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
                    }
                }, 15000);
            }
        }
        
        function createWidget() {
            try {
                console.log('üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞...');
                
                const city = document.getElementById('searchInput').value || '–ú–æ—Å–∫–≤–∞';
                
                // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                yandexWidget = YaDelivery.createWidget({
                    containerId: 'delivery-widget',
                    params: {
                        city: city,
                        size: {
                            height: "100%",
                            width: "100%"
                        },
                        show_select_button: true, // –í–ê–ñ–ù–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞
                        filter: {
                            type: ["pickup_point"],
                            is_yandex_branded: false
                        }
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≤—ã–±–æ—Ä –ü–í–ó
                document.addEventListener('YaNddWidgetPointSelected', handlePointSelected);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –Ø–Ω–¥–µ–∫—Å–∞
                    hideYandexElements();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }
        
        function hideYandexElements() {
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ø–Ω–¥–µ–∫—Å–∞
            setTimeout(() => {
                const widget = document.querySelector('#delivery-widget');
                if (widget) {
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–∞–º–∏ —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ "search"
                    const elements = widget.querySelectorAll('[class*="search"], [class*="Search"]');
                    elements.forEach(el => {
                        el.style.display = 'none';
                    });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º sidebar –µ—Å–ª–∏ –µ—Å—Ç—å
                    const sidebar = widget.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.style.display = 'none';
                    }
                }
            }, 3000);
        }
        
        function updateWidgetCity(city) {
            if (yandexWidget && typeof yandexWidget.update === 'function') {
                try {
                    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:', city);
                    yandexWidget.update({ city: city });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
                    document.getElementById('instruction').style.display = 'none';
                    setTimeout(() => {
                        document.getElementById('instruction').style.display = 'block';
                    }, 3000);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞:', error);
                }
            }
        }
        
        function handlePointSelected(event) {
            console.log('üìç –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', event.detail);
            
            if (!event.detail) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ü–í–ó');
                return;
            }
            
            const point = event.detail;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            selectedPVZ = {
                id: point.id || '',
                name: point.name || '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏',
                address: point.address?.full_address || '',
                city: point.address?.locality || '',
                street: point.address?.street || '',
                house: point.address?.house || '',
                comment: point.address?.comment || '',
                working_hours: point.working_hours || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                phone: point.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'
            };
            
            console.log('‚úÖ –í—ã–±—Ä–∞–Ω –ü–í–ó:', selectedPVZ);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
            sendDataToBot(selectedPVZ);
        }
        
        function sendDataToBot(pvzData) {
            const data = {
                action: 'pvz_selected',
                pvz_id: pvzData.id,
                pvz_name: pvzData.name,
                pvz_address: pvzData.address,
                pvz_working_hours: pvzData.working_hours,
                pvz_phone: pvzData.phone,
                timestamp: Date.now()
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);
            
            if (isTelegram) {
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                    document.getElementById('instruction').style.display = 'none';
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App —á–µ—Ä–µ–∑ 500–º—Å
                    setTimeout(() => {
                        if (Telegram.WebApp && Telegram.WebApp.close) {
                            Telegram.WebApp.close();
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            } else {
                // –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                console.log('[–¢–ï–°–¢] –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã:', data);
                
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('test_pvz_data', JSON.stringify(data));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∞–ª–µ—Ä—Ç–∞ JSON
                alert('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω!\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.');
            }
        }
        
        // –ó–∞–ø—Ä–µ—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
