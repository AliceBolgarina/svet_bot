<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç -->
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            background: white;
            padding: 16px 16px 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 14px;
            color: #666;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ */
        .search-toggle {
            position: absolute;
            top: 80px;
            left: 16px;
            right: 16px;
            z-index: 200;
        }
        
        .search-toggle-btn {
            width: 100%;
            padding: 14px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            color: #667eea;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }
        
        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
        .search-panel {
            position: absolute;
            top: 80px;
            left: 16px;
            right: 16px;
            z-index: 300;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none;
        }
        
        .search-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
        }
        
        .search-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .cancel-btn {
            width: 100%;
            padding: 10px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            position: absolute;
            top: 140px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        #delivery-widget {
            width: 100%;
            height: 100%;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –Ø–Ω–¥–µ–∫—Å–∞ */
        .yandex-delivery-widget .search-bar,
        .yandex-delivery-widget .sidebar {
            display: none !important;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            z-index: 10;
            text-align: center;
        }
        
        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è */
        .instruction {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: white;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #667eea;
            text-align: center;
            font-size: 14px;
            color: #333;
            z-index: 50;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        
        /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 250;
            display: none;
        }
    </style>
</head>
<body>
    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞ -->
    <div class="overlay" id="overlay"></div>
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å –≤–∞—Ä–∏–∞–Ω—Ç</p>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞ -->
    <div class="search-toggle" id="searchToggle">
        <button class="search-toggle-btn" id="searchToggleBtn">
            üîç –ù–∞–π—Ç–∏ –≥–æ—Ä–æ–¥ –∏–ª–∏ –∞–¥—Ä–µ—Å
        </button>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ -->
    <div class="search-panel" id="searchPanel">
        <div class="search-input-group">
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞"
                   value="–ú–æ—Å–∫–≤–∞">
            <button class="search-btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
        </div>
        <button class="cancel-btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
    </div>
    
    <!-- –ö–∞—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å -->
    <div class="map-container">
        <div id="delivery-widget"></div>
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>
    
    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
    <div class="instruction" id="instruction">
        üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç"
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let yandexWidget = null;
        let isTelegram = false;
        let selectedPVZ = null;
        
        // ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–ö–†–´–¢–ò–Ø WEB APP ==========
        function safeCloseWebApp() {
            console.log('üîÑ –ó–∞–∫—Ä—ã—Ç–∏–µ Web App...');
            
            if (window.Telegram && Telegram.WebApp) {
                try {
                    // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
                    if (typeof Telegram.WebApp.close === 'function') {
                        Telegram.WebApp.close();
                        console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Telegram.WebApp.close()');
                        return;
                    }
                    
                    // –ó–∞–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                    if (typeof Telegram.WebApp.hide === 'function') {
                        Telegram.WebApp.hide();
                        console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Telegram.WebApp.hide()');
                    }
                    
                    if (typeof Telegram.WebApp.closeScanQrPopup === 'function') {
                        Telegram.WebApp.closeScanQrPopup();
                        console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Telegram.WebApp.closeScanQrPopup()');
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
                }
            }
            
            // –ö—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π - –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
            setTimeout(() => {
                try {
                    if (window.close && typeof window.close === 'function') {
                        window.close();
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                }
            }, 100);
        }
        
        // ========== –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function initTelegramWebApp() {
            try {
                const tg = Telegram.WebApp;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Web App
                tg.expand(); // –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                tg.setHeaderColor('#ffffff');
                tg.setBackgroundColor('#ffffff');
                tg.enableClosingConfirmation();
                
                // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    safeCloseWebApp();
                });
                
                // –ì–æ—Ç–æ–≤–æ
                tg.ready();
                console.log('‚úÖ Telegram Web App –≥–æ—Ç–æ–≤');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Telegram:', error);
            }
        }
        
        // ========== –ü–û–ò–°–ö ==========
        function initSearch() {
            const toggleBtn = document.getElementById('searchToggleBtn');
            const searchPanel = document.getElementById('searchPanel');
            const searchBtn = document.getElementById('searchBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const searchInput = document.getElementById('searchInput');
            const overlay = document.getElementById('overlay');
            
            // –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫
            toggleBtn.addEventListener('click', function() {
                searchPanel.style.display = 'block';
                overlay.style.display = 'block';
                toggleBtn.style.display = 'none';
                searchInput.focus();
            });
            
            // –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query) {
                    updateWidgetCity(query);
                    closeSearchPanel();
                }
            });
            
            // –û—Ç–º–µ–Ω–∞ –ø–æ–∏—Å–∫–∞
            cancelBtn.addEventListener('click', closeSearchPanel);
            
            // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            overlay.addEventListener('click', closeSearchPanel);
            
            // –ü–æ–∏—Å–∫ –ø–æ Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            function closeSearchPanel() {
                searchPanel.style.display = 'none';
                overlay.style.display = 'none';
                toggleBtn.style.display = 'block';
            }
        }
        
        // ========== –Ø–ù–î–ï–ö–° –í–ò–î–ñ–ï–¢ ==========
        function initYandexWidget() {
            console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞...');
            
            if (window.YaDelivery) {
                createWidget();
            } else {
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                document.addEventListener('YaNddWidgetLoad', createWidget);
                
                // –¢–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
                setTimeout(function() {
                    if (!yandexWidget) {
                        console.error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞');
                        document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    }
                }, 15000);
            }
        }
        
        function createWidget() {
            try {
                console.log('üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞...');
                
                const city = document.getElementById('searchInput').value || '–ú–æ—Å–∫–≤–∞';
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞
                yandexWidget = YaDelivery.createWidget({
                    containerId: 'delivery-widget',
                    params: {
                        city: city,
                        size: {
                            height: "100%",
                            width: "100%"
                        },
                        show_select_button: true, // –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∂–µ—Ç–∞
                        filter: {
                            type: ["pickup_point"],
                            is_yandex_branded: false,
                            payment_methods: ["already_paid", "card_on_receipt"]
                        }
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≤—ã–±–æ—Ä –ü–í–ó
                document.addEventListener('YaNddWidgetPointSelected', handlePointSelected);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
                setTimeout(function() {
                    document.getElementById('loading').style.display = 'none';
                    console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
            }
        }
        
        function updateWidgetCity(city) {
            if (yandexWidget && typeof yandexWidget.update === 'function') {
                try {
                    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:', city);
                    yandexWidget.update({ city: city });
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                    document.getElementById('instruction').style.opacity = '0.5';
                    setTimeout(function() {
                        document.getElementById('instruction').style.opacity = '1';
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞:', error);
                }
            }
        }
        
        // ========== –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –ü–í–ó ==========
        function handlePointSelected(event) {
            console.log('üìç –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –ü–í–ó');
            
            if (!event || !event.detail) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ü–í–ó');
                return;
            }
            
            const point = event.detail;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            selectedPVZ = {
                id: point.id || '',
                name: point.name || '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏',
                address: point.address?.full_address || '',
                city: point.address?.locality || '',
                street: point.address?.street || '',
                house: point.address?.house || '',
                comment: point.address?.comment || '',
                working_hours: point.working_hours || '',
                phone: point.phone || ''
            };
            
            console.log('‚úÖ –í—ã–±—Ä–∞–Ω –ü–í–ó:', selectedPVZ.name);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç
            sendDataToBot(selectedPVZ);
        }
        
        function sendDataToBot(pvzData) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            const data = {
                action: 'pvz_selected',
                pvz_id: pvzData.id,
                pvz_name: pvzData.name,
                pvz_address: pvzData.address,
                pvz_working_hours: pvzData.working_hours || '',
                pvz_phone: pvzData.phone || '',
                timestamp: Date.now()
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç:', data);
            
            if (isTelegram) {
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
                    Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                    document.getElementById('instruction').style.display = 'none';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    Telegram.WebApp.showPopup({
                        title: '–£—Å–ø–µ—à–Ω–æ!',
                        message: '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω',
                        buttons: [{ type: 'ok' }]
                    }, function(btnId) {
                        // –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –û–ö –∑–∞–∫—Ä—ã–≤–∞–µ–º Web App
                        safeCloseWebApp();
                    });
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    
                    // Fallback: –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    alert('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –±–æ—Ç–∞.');
                    safeCloseWebApp();
                }
            } else {
                // –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                console.log('[–¢–ï–°–¢] –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ:', data);
                alert('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω!\n\n–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏.');
            }
        }
        
        // ========== –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ó–∞–ø—É—Å–∫ Web App...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                isTelegram = true;
                initTelegramWebApp();
            } else {
                console.log('‚ö†Ô∏è –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ Telegram)');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
            initSearch();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç
            initYandexWidget();
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ iOS
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>
