<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Выбор пункта выдачи</title>
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: white; height: 100vh; overflow: hidden; }
        
        .header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .map-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        #widget-container {
            width: 100%;
            height: 100%;
        }
        
        /* Скрываем ВСЕ элементы Яндекса кроме карты */
        .yandex-delivery-widget > div:not([class*="map"]) {
            display: none !important;
        }
        
        /* Скрываем поиск, сайдбар и т.д. */
        .search-bar, .sidebar, .search-panel, [class*="search"], [class*="Search"] {
            display: none !important;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Выберите пункт выдачи</h1>
        <p>Нажмите на пункт на карте</p>
    </div>
    
    <div class="map-container">
        <div id="widget-container"></div>
        <div class="loading" id="loading">Загрузка карты...</div>
    </div>

    <script>
        // Минимальный код - только самое необходимое
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Запуск карты...');
            
            // Настройка для Telegram
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.expand();
                Telegram.WebApp.BackButton.show();
                Telegram.WebApp.BackButton.onClick(() => {
                    Telegram.WebApp.close();
                });
            }
            
            // Загрузка Яндекс виджета
            if (window.YaDelivery) {
                initMap();
            } else {
                document.addEventListener('YaNddWidgetLoad', initMap);
            }
        });
        
        function initMap() {
            try {
                // ОЧЕНЬ ПРОСТАЯ конфигурация
                YaDelivery.createWidget({
                    containerId: 'widget-container',
                    params: {
                        city: "Москва",
                        size: { height: "100%", width: "100%" },
                        show_select_button: true,
                        filter: { type: ["pickup_point"] }
                    }
                });
                
                // Обработчик выбора ПВЗ
                document.addEventListener('YaNddWidgetPointSelected', function(event) {
                    if (!event.detail) return;
                    
                    const pvz = event.detail;
                    const data = {
                        action: 'pvz_selected',
                        pvz_id: pvz.id || '',
                        pvz_name: pvz.name || 'Пункт выдачи',
                        pvz_address: pvz.address?.full_address || '',
                        pvz_working_hours: pvz.working_hours || '',
                        pvz_phone: pvz.phone || ''
                    };
                    
                    console.log('Отправка данных:', data);
                    
                    // Отправляем в Telegram
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.sendData(JSON.stringify(data));
                        // ЗАКРЫВАЕМ БЕЗ АЛЕРТОВ
                        setTimeout(() => Telegram.WebApp.close(), 100);
                    } else {
                        // Для теста
                        console.log('Тестовые данные:', data);
                        // Никаких алертов!
                    }
                });
                
                // Скрываем загрузку
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }
    </script>
</body>
</html>
