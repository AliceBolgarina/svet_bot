<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; background: white; }
        
        .header {
            background: white; padding: 12px 16px; text-align: center; border-bottom: 1px solid #e0e0e0;
        }
        
        .header h1 { font-size: 18px; color: #333; margin-bottom: 2px; }
        .header p { font-size: 13px; color: #666; }
        
        .map-container {
            position: absolute; top: 70px; left: 0; right: 0; bottom: 0;
        }
        
        #widget-container { width: 100%; height: 100%; }
        
        .loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 16px; color: #666; background: white; padding: 15px 25px;
            border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .select-btn {
            position: fixed; bottom: 20px; left: 20px; right: 20px; padding: 16px;
            background: #667eea; color: white; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; text-align: center; cursor: pointer;
            z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .select-btn:active { background: #5a67d8; }
        
        .debug {
            position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8);
            color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;
            z-index: 2000; max-width: 200px;
        }
        
        .warning {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px;
            border-radius: 10px; text-align: center; z-index: 3000; display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h1>
        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ</p>
    </div>
    
    <div class="map-container">
        <div id="widget-container"></div>
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>
    
    <button class="select-btn" id="selectBtn">‚úÖ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç</button>
    
    <div class="debug" id="debug">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="warning" id="warning">
        <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</h3>
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ Web App –∑–∞–Ω–æ–≤–æ.</p>
        <button onclick="location.reload()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let tg = null;
        let selectedPVZ = null;
        let isTelegramReady = false;
        
        // ========== –ü–†–û–í–ï–†–ö–ê TELEGRAM ==========
        function initTelegram() {
            console.log('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram...');
            
            if (!window.Telegram || !Telegram.WebApp) {
                console.error('‚ùå Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω');
                showWarning('Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            tg = Telegram.WebApp;
            console.log('‚úÖ Telegram.WebApp –Ω–∞–π–¥–µ–Ω');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (!tg.initData) {
                console.error('‚ùå –ù–ï–¢ initData! Web App –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                console.log('–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–æ–º—É —á—Ç–æ:');
                console.log('1. Web App –æ—Ç–∫—Ä—ã—Ç –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ');
                console.log('2. Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ');
                console.log('3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–µ—Ä—Å–∏–µ–π Telegram');
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ ready()
                tg.expand();
                tg.ready();
                
                // –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
                setTimeout(() => {
                    if (!tg.initData) {
                        console.error('‚ùå –ü–æ—Å–ª–µ ready() initData –≤—Å—ë –µ—â–µ –Ω–µ—Ç');
                        showWarning('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Telegram. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–Ω–æ–≤–æ.');
                        return false;
                    } else {
                        console.log('‚úÖ initData –ø–æ—è–≤–∏–ª—Å—è –ø–æ—Å–ª–µ ready()');
                        isTelegramReady = true;
                        updateDebug('Telegram ‚úÖ (–ø–æ—Å–ª–µ ready)');
                        initYandexWidget();
                        return true;
                    }
                }, 1000);
                
                return false;
            }
            
            // –ï—Å–ª–∏ initData –µ—Å—Ç—å
            console.log('‚úÖ initData –µ—Å—Ç—å, –¥–ª–∏–Ω–∞:', tg.initData.length);
            console.log('üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', tg.platform);
            console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:', tg.initDataUnsafe?.user?.id);
            
            tg.expand();
            tg.ready();
            
            isTelegramReady = true;
            updateDebug('Telegram ‚úÖ');
            return true;
        }
        
        // ========== –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï ==========
        function showWarning(message) {
            const warning = document.getElementById('warning');
            const loading = document.getElementById('loading');
            
            if (warning) {
                warning.style.display = 'block';
                warning.innerHTML = `<h3>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h3><p>${message}</p><button onclick="location.reload()">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>`;
            }
            
            if (loading) {
                loading.style.display = 'none';
            }
            
            updateDebug(`‚ùå ${message}`);
        }
        
        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–õ–ê–î–ö–ò ==========
        function updateDebug(message) {
            const debugEl = document.getElementById('debug');
            if (debugEl) {
                debugEl.textContent = message;
            }
        }
        
        // ========== –Ø–ù–î–ï–ö–° –í–ò–î–ñ–ï–¢ ==========
        function initYandexWidget() {
            console.log('üõ†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞...');
            
            try {
                const testStationId = "05e809bb-4521-42d9-a936-0fb0744c0fb3";
                
                YaDelivery.createWidget({
                    containerId: 'widget-container',
                    params: {
                        city: "–ú–æ—Å–∫–≤–∞",
                        size: { height: "100%", width: "100%" },
                        source_platform_station: testStationId,
                        physical_dims_weight_gross: 1000,
                        delivery_price: "–æ—Ç 300 ‚ÇΩ",
                        delivery_term: "1-3 –¥–Ω—è",
                        show_select_button: false,
                        filter: {
                            type: ["pickup_point"],
                            is_yandex_branded: false
                        }
                    }
                });
                
                console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞–Ω');
                updateDebug('Telegram ‚úÖ | –Ø–Ω–¥–µ–∫—Å ‚úÖ');
                
                document.addEventListener('YaNddWidgetPointSelected', function(event) {
                    console.log('üìç –ü–í–ó –≤—ã–±—Ä–∞–Ω–æ:', event.detail);
                    
                    if (!event.detail) return;
                    
                    selectedPVZ = {
                        id: event.detail.id || '',
                        name: event.detail.name || '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏',
                        address: event.detail.address?.full_address || ''
                    };
                    
                    console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –ü–í–ó:', selectedPVZ);
                    
                    const btn = document.getElementById('selectBtn');
                    btn.style.display = 'block';
                    
                    const shortName = selectedPVZ.name.length > 20 
                        ? selectedPVZ.name.substring(0, 20) + '...' 
                        : selectedPVZ.name;
                    btn.textContent = `‚úÖ –í—ã–±—Ä–∞—Ç—å "${shortName}"`;
                    
                    updateDebug('Telegram ‚úÖ | –Ø–Ω–¥–µ–∫—Å ‚úÖ | –ü–í–ó –≤—ã–±—Ä–∞–Ω–æ ‚úÖ');
                });
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –Ø–Ω–¥–µ–∫—Å:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã';
                updateDebug('Telegram ‚úÖ | –Ø–Ω–¥–µ–∫—Å ‚ùå');
            }
        }
        
        // ========== –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• ==========
        function sendDataToTelegram() {
            console.log('='.repeat(50));
            console.log('üöÄ –ü–û–ü–´–¢–ö–ê –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–•');
            
            if (!selectedPVZ) {
                console.log('‚ùå –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ü–í–ó');
                return;
            }
            
            if (!isTelegramReady || !tg) {
                console.log('‚ùå Telegram –Ω–µ –≥–æ—Ç–æ–≤');
                showWarning('Telegram –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º initData –µ—â–µ —Ä–∞–∑
            if (!tg.initData) {
                console.log('‚ùå –ù–ï–¢ initData, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞');
                showWarning('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            const data = {
                action: 'pvz_selected',
                pvz_id: selectedPVZ.id,
                pvz_name: selectedPVZ.name,
                pvz_address: selectedPVZ.address,
                timestamp: Date.now(),
                user_id: tg.initDataUnsafe?.user?.id || 'unknown',
                chat_id: tg.initDataUnsafe?.chat?.id || 'unknown'
            };
            
            const jsonData = JSON.stringify(data);
            console.log('üì¶ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', jsonData);
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:');
            console.log('- tg:', !!tg);
            console.log('- tg.sendData:', tg && typeof tg.sendData);
            console.log('- tg.initData:', tg.initData ? `–ï—Å—Ç—å (${tg.initData.length} chars)` : '–ù–µ—Ç');
            console.log('- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:', tg.initDataUnsafe?.user?.id);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                tg.sendData(jsonData);
                console.log('‚úÖ sendData() –≤—ã–∑–≤–∞–Ω');
                updateDebug('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
                
                // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É! –ü—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                // setTimeout(() => {
                //     if (tg && tg.close) {
                //         tg.close();
                //         console.log('‚úÖ Web App –∑–∞–∫—Ä—ã—Ç');
                //     }
                // }, 2000);
                
                // –í–º–µ—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const btn = document.getElementById('selectBtn');
                btn.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ.';
                btn.style.background = '#28a745';
                btn.disabled = true;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ sendData:', error);
                updateDebug('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                showWarning('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
            
            console.log('='.repeat(50));
        }
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ó–∞–ø—É—Å–∫ Web App...');
            
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
            const telegramOk = initTelegram();
            
            // 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            document.getElementById('selectBtn').addEventListener('click', sendDataToTelegram);
            
            // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ø–Ω–¥–µ–∫—Å –µ—Å–ª–∏ Telegram –æ–∫
            if (telegramOk) {
                if (typeof YaDelivery !== 'undefined') {
                    initYandexWidget();
                } else {
                    document.addEventListener('YaNddWidgetLoad', initYandexWidget);
                }
            }
        });
    </script>
</body>
</html>
