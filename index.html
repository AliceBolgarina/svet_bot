<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç -->
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            background: #ffffff;
            padding: 16px 16px 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            position: relative;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin: 0;
        }
        
        .header p {
            font-size: 13px;
            color: #666666;
            margin-top: 4px;
        }
        
        /* –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ - —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π */
        .search-container {
            position: absolute;
            top: 80px;
            left: 16px;
            right: 16px;
            z-index: 2000;
            display: none; /* –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã—Ç */
        }
        
        .search-box {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            font-size: 16px;
            outline: none;
            background: transparent;
        }
        
        .search-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞ */
        .open-search {
            position: absolute;
            top: 80px;
            left: 16px;
            right: 16px;
            z-index: 1500;
        }
        
        .open-search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            height: calc(100vh - 73px);
            width: 100%;
            position: relative;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞ */
        #yandex-map .yandex-delivery-widget .sidebar,
        #yandex-map .yandex-delivery-widget .search-panel {
            display: none !important;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            color: #333;
            font-size: 16px;
            z-index: 100;
        }
        
        /* –û—à–∏–±–∫–∞ */
        .error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 80%;
            text-align: center;
            color: #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 200;
        }
        
        .error h3 {
            margin-bottom: 10px;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ</p>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞ -->
    <div class="open-search" id="openSearch">
        <button class="open-search-btn" id="openSearchBtn">
            üîç –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ –∞–¥—Ä–µ—Å–∞
        </button>
    </div>
    
    <!-- –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="search-container" id="searchContainer">
        <div class="search-box">
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞"
                   value="–ú–æ—Å–∫–≤–∞">
            <button class="search-button" id="searchButton">–ù–∞–π—Ç–∏</button>
        </div>
    </div>
    
    <!-- –ö–∞—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å -->
    <div class="map-container">
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        <div id="yandex-map" style="display: none;"></div>
        
        <div class="error" id="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</p>
        </div>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let yandexWidget = null;
        let isTelegram = false;
        let selectedPVZ = null;
        let searchVisible = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web App...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                isTelegram = true;
                initTelegram();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
            initSearch();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞
            loadYandexWidget();
        });
        
        function initTelegram() {
            try {
                const tg = Telegram.WebApp;
                
                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram Web App
                tg.expand();
                tg.setHeaderColor('#ffffff');
                tg.setBackgroundColor('#ffffff');
                tg.enableClosingConfirmation();
                
                // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
                tg.BackButton.show();
                tg.BackButton.onClick(function() {
                    tg.close();
                });
                
                console.log('‚úÖ Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                tg.ready();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram:', error);
            }
        }
        
        function initSearch() {
            const openSearchBtn = document.getElementById('openSearchBtn');
            const searchContainer = document.getElementById('searchContainer');
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('searchInput');
            
            // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞
            openSearchBtn.addEventListener('click', function() {
                searchVisible = !searchVisible;
                if (searchVisible) {
                    searchContainer.style.display = 'block';
                    openSearchBtn.style.display = 'none';
                    searchInput.focus();
                } else {
                    searchContainer.style.display = 'none';
                    openSearchBtn.style.display = 'block';
                }
            });
            
            // –ü–æ–∏—Å–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            searchButton.addEventListener('click', function() {
                performSearch(searchInput.value);
            });
            
            // –ü–æ–∏—Å–∫ –ø–æ Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch(searchInput.value);
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(e) {
                if (searchVisible && 
                    !searchContainer.contains(e.target) && 
                    !openSearchBtn.contains(e.target)) {
                    searchContainer.style.display = 'none';
                    openSearchBtn.style.display = 'block';
                    searchVisible = false;
                }
            });
        }
        
        function performSearch(query) {
            if (!query || query.trim() === '') {
                return;
            }
            
            console.log('üîç –ü–æ–∏—Å–∫:', query);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('openSearch').style.display = 'block';
            searchVisible = false;
            
            if (yandexWidget && typeof yandexWidget.update === 'function') {
                try {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É —Å –Ω–æ–≤—ã–º –≥–æ—Ä–æ–¥–æ–º
                    yandexWidget.update({ city: query });
                    document.getElementById('searchInput').value = query;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
                }
            }
        }
        
        function loadYandexWidget() {
            console.log('üó∫Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            if (window.YaDelivery) {
                createYandexWidget();
            } else {
                // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                document.addEventListener('YaNddWidgetLoad', function() {
                    console.log('üì¶ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ø–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    createYandexWidget();
                });
                
                // –¢–∞–π–º–∞—É—Ç –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
                setTimeout(function() {
                    if (!yandexWidget) {
                        console.error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞');
                        document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
                        setTimeout(showError, 2000);
                    }
                }, 10000);
            }
        }
        
        function createYandexWidget() {
            try {
                console.log('üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞...');
                
                const city = document.getElementById('searchInput').value || '–ú–æ—Å–∫–≤–∞';
                
                // –°–æ–∑–¥–∞—ë–º –≤–∏–¥–∂–µ—Ç
                yandexWidget = YaDelivery.createWidget({
                    containerId: 'yandex-map',
                    params: {
                        city: city,
                        size: {
                            height: "100%",
                            width: "100%"
                        },
                        show_select_button: true,
                        filter: {
                            type: ["pickup_point", "terminal"],
                            is_yandex_branded: false,
                            payment_methods: ["already_paid", "card_on_receipt"]
                        }
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
                document.addEventListener('YaNddWidgetPointSelected', handlePVZSelection);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
                setTimeout(function() {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('yandex-map').style.display = 'block';
                    console.log('‚úÖ –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –Ø–Ω–¥–µ–∫—Å–∞
                    hideYandexSearch();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:', error);
                showError();
            }
        }
        
        function hideYandexSearch() {
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä—ã—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –Ø–Ω–¥–µ–∫—Å–∞
            setTimeout(function() {
                const widget = document.querySelector('#yandex-map .yandex-delivery-widget');
                if (widget) {
                    const searchPanel = widget.querySelector('.search-panel');
                    const sidebar = widget.querySelector('.sidebar');
                    
                    if (searchPanel) searchPanel.style.display = 'none';
                    if (sidebar) sidebar.style.display = 'none';
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—â–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const elements = widget.querySelectorAll('[class*="search"], [class*="Search"]');
                    elements.forEach(el => {
                        if (el.textContent.includes('–ø–æ–∏—Å–∫') || 
                            el.textContent.includes('–ü–æ–∏—Å–∫') ||
                            el.style.display !== 'none') {
                            el.style.display = 'none';
                        }
                    });
                }
            }, 2000);
        }
        
        function handlePVZSelection(event) {
            console.log('üìç –í—ã–±–æ—Ä –ü–í–ó:', event.detail);
            
            if (!event || !event.detail) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ü–í–ó');
                return;
            }
            
            const pvz = event.detail;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            selectedPVZ = {
                id: pvz.id || '',
                name: pvz.name || '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏',
                address: pvz.address?.full_address || '',
                city: pvz.address?.locality || '',
                street: pvz.address?.street || '',
                house: pvz.address?.house || '',
                comment: pvz.address?.comment || '',
                working_hours: pvz.working_hours || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                phone: pvz.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'
            };
            
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ü–í–ó:', selectedPVZ);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
            sendToTelegram(selectedPVZ);
        }
        
        function sendToTelegram(pvzData) {
            const data = {
                action: 'pvz_selected',
                pvz_id: pvzData.id,
                pvz_name: pvzData.name,
                pvz_address: pvzData.address,
                pvz_working_hours: pvzData.working_hours,
                pvz_phone: pvzData.phone,
                selected_at: new Date().toISOString()
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);
            
            if (isTelegram) {
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // –ë–µ–∑ –∞–ª–µ—Ä—Ç–æ–≤! –ü—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
                    setTimeout(() => {
                        Telegram.WebApp.close();
                    }, 300);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                }
            } else {
                // –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                alert('‚úÖ –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ:\n\n' + 
                      JSON.stringify(data, null, 2));
                
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                console.log('üì§ [–¢–ï–°–¢] –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:', data);
            }
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('yandex-map').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
