<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏</title>
    
    <!-- –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç -->
    <script src="https://ndd-widget.landpro.site/widget.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            background: #ffffff;
            padding: 20px 20px 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            position: relative;
            z-index: 10;
            height: 70px;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin: 0;
        }
        
        .header p {
            font-size: 13px;
            color: #666666;
            margin-top: 4px;
        }
        
        /* –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ - –≤–≤–µ—Ä—Ö—É –Ω–∞–¥ –∫–∞—Ä—Ç–æ–π */
        .address-search {
            position: absolute;
            top: 75px;
            left: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            height: 44px;
        }
        
        .address-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .search-btn {
            width: 44px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã */
        .map-container {
            height: calc(100vh - 70px); /* –º–∏–Ω—É—Å –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
            width: 100%;
            position: relative;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 16px;
            text-align: center;
            z-index: 1;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        #yandex-map {
            width: 100%;
            height: 100%;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ */
        .error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            max-width: 80%;
            text-align: center;
            color: #856404;
            z-index: 2;
        }
        
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–Ω–∏–∑—É */
        .hint {
            position: absolute;
            bottom: 10px;
            left: 15px;
            right: 15px;
            text-align: center;
            color: white;
            font-size: 12px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            z-index: 100;
        }
        
        /* –û—Ç–∫–ª—é—á–∏—Ç—å —Å–∫—Ä–æ–ª–ª */
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="header">
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h1>
        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—É–Ω–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ</p>
    </div>
    
    <!-- –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ -->
    <div class="address-search" id="addressSearch">
        <input type="text" 
               class="address-input" 
               id="addressInput" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≥–æ—Ä–æ–¥..."
               value="–ú–æ—Å–∫–≤–∞">
        <button class="search-btn" id="searchBtn">üîç</button>
    </div>
    
    <!-- –ö–∞—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å -->
    <div class="map-container">
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        <div id="yandex-map" style="display: none;"></div>
        <div class="error" id="error">
            –ö–∞—Ä—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.<br>
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
        </div>
        
        <div class="hint" id="hint">
            üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ü–í–ó –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç"
        </div>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedPVZ = null;
        let isTelegram = false;
        let yandexWidget = null;
        let widgetInitialized = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å–ª–∏ —ç—Ç–æ Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                isTelegram = true;
                initTelegram();
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                console.log('‚ö†Ô∏è –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
            initSearch();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞
            initYandexWidget();
        });
        
        function initTelegram() {
            const tg = Telegram.WebApp;
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Telegram Web App
            tg.expand();  // –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.setHeaderColor('#ffffff');  // –ë–µ–ª—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            tg.setBackgroundColor('#ffffff');  // –ë–µ–ª—ã–π —Ñ–æ–Ω
            tg.enableClosingConfirmation();  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            tg.ready();  // –ì–æ—Ç–æ–≤—ã
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ Telegram
            tg.BackButton.show();
            tg.BackButton.onClick(function() {
                tg.close();
            });
            
            console.log('‚úÖ Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }
        
        function initSearch() {
            const addressInput = document.getElementById('addressInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchBtn.addEventListener('click', function() {
                searchAddress(addressInput.value);
            });
            
            addressInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress(addressInput.value);
                }
            });
        }
        
        function initYandexWidget() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            if (window.YaDelivery) {
                createYandexWidget();
            } else {
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
                document.addEventListener('YaNddWidgetLoad', createYandexWidget);
                
                // –ï—Å–ª–∏ –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                setTimeout(function() {
                    if (!widgetInitialized) {
                        showError();
                    }
                }, 10000);
            }
        }
        
        function createYandexWidget() {
            try {
                console.log('üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç–∞...');
                
                const address = document.getElementById('addressInput').value || '–ú–æ—Å–∫–≤–∞';
                
                // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–ï–ó —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —Å—Ä–æ–∫–æ–≤
                yandexWidget = YaDelivery.createWidget({
                    containerId: 'yandex-map',
                    params: {
                        city: address,
                        size: {
                            height: "100%",
                            width: "100%"
                        },
                        // –£–±—Ä–∞–ª–∏ —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —Å—Ä–æ–∫–æ–≤
                        show_select_button: true,  // –ö–Ω–æ–ø–∫–∞ "–í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç" –≤–Ω—É—Ç—Ä–∏ –≤–∏–¥–∂–µ—Ç–∞
                        filter: {
                            type: ["pickup_point", "terminal"],
                            is_yandex_branded: false,
                            payment_methods: ["already_paid", "card_on_receipt"],
                            payment_methods_filter: "or"
                        }
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –ü–í–ó
                document.addEventListener('YaNddWidgetPointSelected', handlePVZSelected);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
                document.getElementById('loading').style.display = 'none';
                document.getElementById('yandex-map').style.display = 'block';
                widgetInitialized = true;
                
                console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –≤–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞–Ω');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:', error);
                showError();
            }
        }
        
        function handlePVZSelected(event) {
            console.log('üìç –°–æ–±—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –ü–í–ó:', event);
            
            if (!event || !event.detail) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ü–í–ó');
                return;
            }
            
            const pvzData = event.detail;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ü–í–ó
            selectedPVZ = {
                id: pvzData.id || '',
                name: pvzData.name || '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏',
                address: pvzData.address?.full_address || '',
                country: pvzData.address?.country || '',
                city: pvzData.address?.locality || '',
                street: pvzData.address?.street || '',
                house: pvzData.address?.house || '',
                comment: pvzData.address?.comment || '',
                working_hours: pvzData.working_hours || '',
                phone: pvzData.phone || ''
            };
            
            console.log('‚úÖ –í—ã–±—Ä–∞–Ω –ü–í–ó:', selectedPVZ);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            document.getElementById('hint').style.display = 'none';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
            sendToTelegram(selectedPVZ);
        }
        
        function sendToTelegram(pvzData) {
            const data = {
                action: 'pvz_selected',
                pvz_id: pvzData.id,
                pvz_name: pvzData.name,
                pvz_address: pvzData.address,
                pvz_working_hours: pvzData.working_hours || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                pvz_phone: pvzData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω',
                selected_at: new Date().toISOString()
            };
            
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);
            
            if (isTelegram) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram Web App
                Telegram.WebApp.sendData(JSON.stringify(data));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                Telegram.WebApp.showPopup({
                    title: '–£—Å–ø–µ—à–Ω–æ!',
                    message: '–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω',
                    buttons: [{ type: 'ok' }]
                });
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    Telegram.WebApp.close();
                }, 1000);
                
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
                alert('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω!\n\n–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.');
                console.log('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
            }
        }
        
        function searchAddress(address) {
            if (!address || address.trim() === '') {
                return;
            }
            
            console.log('üîç –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞:', address);
            
            if (yandexWidget && typeof yandexWidget.update === 'function') {
                try {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    document.getElementById('loading').style.display = 'block';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –≤ –≤–∏–¥–∂–µ—Ç–µ
                    yandexWidget.update({ city: address });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
                    document.getElementById('loading').style.display = 'none';
                }
            } else {
                // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('addressInput').value = address;
            }
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('yandex-map').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑—É–º –Ω–∞ iOS
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
