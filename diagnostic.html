<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Web App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { display: block; width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; }
        .good { color: green; font-weight: bold; }
        .bad { color: red; font-weight: bold; }
        .info { background: #f0f0f0; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram Web App</h1>
    
    <div id="status" class="info">
        –ü—Ä–æ–≤–µ—Ä–∫–∞...
    </div>
    
    <button onclick="diagnose()">ü©∫ –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
    <button onclick="sendTestData()" id="sendBtn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</button>
    
    <div id="results" class="info"></div>

    <script>
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        const sendBtn = document.getElementById('sendBtn');
        let tg = null;
        let canSend = false;
        
        function logToResults(msg) {
            results.innerHTML += msg + '<br>';
            console.log(msg);
        }
        
        function clearResults() {
            results.innerHTML = '';
        }
        
        function diagnose() {
            clearResults();
            logToResults('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM WEB APP ===');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç Telegram
            if (!window.Telegram) {
                logToResults('‚ùå window.Telegram –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                status.innerHTML = '<span class="bad">‚ùå Telegram –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>';
                return;
            }
            
            logToResults('‚úÖ window.Telegram —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram.WebApp
            if (!Telegram.WebApp) {
                logToResults('‚ùå Telegram.WebApp –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                status.innerHTML = '<span class="bad">‚ùå Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω</span>';
                return;
            }
            
            tg = Telegram.WebApp;
            logToResults('‚úÖ Telegram.WebApp –Ω–∞–π–¥–µ–Ω');
            
            // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
            try {
                tg.expand();
                if (tg.ready) tg.ready();
                logToResults('‚úÖ Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (e) {
                logToResults(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${e.message}`);
            }
            
            // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
            logToResults(`üì± –í–µ—Ä—Å–∏—è: ${tg.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
            logToResults(`üñ•Ô∏è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${tg.platform || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
            
            // 5. –ü–†–û–í–ï–†–Ø–ï–ú initData - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!
            if (!tg.initData) {
                logToResults('<span class="bad">‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–û: –ù–ï–¢ initData!</span>');
                logToResults('–≠—Ç–æ –∑–Ω–∞—á–∏—Ç Web App –æ—Ç–∫—Ä—ã—Ç –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                logToResults('–ë–µ–∑ initData Telegram –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É');
                status.innerHTML = '<span class="bad">‚ùå –†–µ–∂–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–Ω–µ—Ç initData)</span>';
                canSend = false;
                sendBtn.disabled = true;
                sendBtn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ - –Ω–µ—Ç initData)';
            } else {
                logToResults(`<span class="good">‚úÖ initData –ï–°–¢–¨! (${tg.initData.length} —Å–∏–º–≤–æ–ª–æ–≤)</span>`);
                logToResults(`üë§ User ID: ${tg.initDataUnsafe?.user?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                logToResults(`üí¨ Chat ID: ${tg.initDataUnsafe?.chat?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                logToResults(`üèÅ Start param: ${tg.initDataUnsafe?.start_param || '–Ω–µ—Ç'}`);
                
                status.innerHTML = '<span class="good">‚úÖ Web App –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</span>';
                canSend = true;
                sendBtn.disabled = false;
                sendBtn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ';
            }
            
            // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ sendData
            if (typeof tg.sendData !== 'function') {
                logToResults('<span class="bad">‚ùå tg.sendData –Ω–µ —Ñ—É–Ω–∫—Ü–∏—è!</span>');
                canSend = false;
                sendBtn.disabled = true;
            } else {
                logToResults('‚úÖ tg.sendData —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π');
            }
            
            logToResults('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===');
        }
        
        function sendTestData() {
            if (!canSend || !tg) {
                logToResults('‚ùå –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞');
                return;
            }
            
            clearResults();
            logToResults('=== –û–¢–ü–†–ê–í–ö–ê –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–• ===');
            
            const testData = {
                action: 'diagnostic_test',
                message: '–¢–µ—Å—Ç –∏–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ Web App',
                timestamp: new Date().toISOString(),
                user_id: tg.initDataUnsafe?.user?.id || 'unknown',
                chat_id: tg.initDataUnsafe?.chat?.id || 'unknown',
                has_initData: !!tg.initData,
                initData_length: tg.initData ? tg.initData.length : 0
            };
            
            logToResults(`üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(testData)}`);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
                tg.sendData(JSON.stringify(testData));
                logToResults('<span class="good">‚úÖ tg.sendData() —É—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω</span>');
                logToResults('–ï—Å–ª–∏ –≤ –±–æ—Ç–µ –Ω–µ—Ç –ª–æ–≥–æ–≤, –∑–Ω–∞—á–∏—Ç Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                logToResults('<br>üìã –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:');
                logToResults('1. Telegram –ø–æ–ª—É—á–∏–ª –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sendData()');
                logToResults('2. Telegram –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö –±–æ—Ç—É –∫–∞–∫ web_app_data');
                logToResults('3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Ö');
                logToResults('4. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã!"');
                
            } catch (error) {
                logToResults(`<span class="bad">‚ùå –û—à–∏–±–∫–∞ sendData: ${error.message}</span>`);
            }
            
            logToResults('=== –û–¢–ü–†–ê–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===');
        }
        
        // –ê–≤—Ç–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            status.innerHTML = '–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É"';
            setTimeout(diagnose, 1000);
        });
    </script>
</body>
</html>
